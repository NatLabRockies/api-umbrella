#!/usr/bin/env bash

trafficserver_version="10.1.1"
trafficserver_hash="8f2e67da1f84343f8c3136c3686324bfe77418e46e33603cf73b4e1c174714db90171ddc169b64707bc3e0dba84b77d77aa404786edf0047a552af8d3b73a86c"

set -e -u -x
source ./tasks/helpers.sh
source ./tasks/helpers/detect_os_release.sh

task_working_dir
download "https://archive.apache.org/dist/trafficserver/trafficserver-$trafficserver_version.tar.bz2" "sha512" "$trafficserver_hash"
extract_download "trafficserver-$trafficserver_version.tar.bz2"

cd "trafficserver-$trafficserver_version"

# Since we log directly to stderr/stdout, backport this patch:
# https://github.com/apache/trafficserver/pull/12407
patch -p1 < "$SOURCE_DIR/build/patches/trafficserver-stderr-logging.patch"

cmake -B build \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX_EMBEDDED" \
  -DENABLE_LUAJIT=ON \
  -Dluajit_INCLUDE_DIRS="$STAGE_EMBEDDED_DIR/openresty/luajit/include/luajit-2.1" \
  -Dluajit_LIBRARY_DIRS="$STAGE_EMBEDDED_DIR/openresty/luajit/lib" \
  -Dluajit_LIBRARIES=luajit-5.1 \
  -Dluajit_LINK_LIBRARIES=luajit-5.1 \
  -DENABLE_JEMALLOC=ON

cmake --build build -j "$NPROC"

cmake --install build --prefix="$STAGE_EMBEDDED_DIR"

chrpath -d "$STAGE_EMBEDDED_DIR/lib/libswoc.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtsapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libtscppapi.so"
chrpath -d "$STAGE_EMBEDDED_DIR/lib/libyaml-cpp.so"
find "$STAGE_EMBEDDED_DIR/libexec/trafficserver/" -name "*.so" -exec chrpath -d {} \;
find "$STAGE_EMBEDDED_DIR/bin/" -name "traffic_*" -exec chrpath -d {} \;

stamp
