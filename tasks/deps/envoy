#!/usr/bin/env bash

set -e -u -x
source ./tasks/helpers.sh

envoy_version="1.37.0"
envoy_hash="0a5729ee4e980d346ebcee80f18e7efe5232b91141bb4c776ec3adcca786e60c"

download_arch="$TARGETARCH"
if [ "$TARGETARCH" == "amd64" ]; then
  download_arch="x86_64"
elif [ "$TARGETARCH" == "arm64" ]; then
  download_arch="aarch_64"
  envoy_hash="f4a12ac9211bc0ee77c8dda869722b6d28a1e9d9b62cdb97ec8f20de8200fa28"
fi

task_working_dir
download "https://github.com/envoyproxy/envoy/releases/download/v${envoy_version}/envoy-${envoy_version}-linux-${download_arch}" "sha256" "$envoy_hash"

install -D -m 755 "_persist/downloads/envoy-${envoy_version}-linux-${download_arch}" "$STAGE_EMBEDDED_DIR/bin/envoy"
chrpath -d "$STAGE_EMBEDDED_DIR/bin/envoy"

stamp
